<!DOCTYPE html><!--HTML5 doctype-->
<html>
<head>
<title>oAuth - Lunch Call</title>
<meta http-equiv="Content-type" content="text/html; charset=utf-8"> 
<style type="text/css">
    /* Prevent copy paste for all elements except text fields */
    *  { -webkit-user-select:none; -webkit-tap-highlight-color:rgba(255, 255, 255, 0); }
    input, textarea  { -webkit-user-select:text; }
    
    /* Set up the page with a default background image */
    body {
        background-color:#fff;
        color:#000;
        font-family:Arial;
        font-size:36pt;
        margin:0px;padding:0px;
        background-image:url('images/Background.png');
    }
	button {
		font-size:24pt;
	}
</style>
<script type="text/javascript" charset="utf-8" src="http://localhost:58888/_appMobi/appmobi.js"></script> 
<script type="text/javascript" charset="utf-8" src="preloadImages.js"></script> 
<script type="text/javascript" charset="utf-8" src="confirmationBox.js"></script> 
<script type="text/javascript">

	function food(inText,inImage)  //food object
	{
		this.text=inText;
		this.image = inImage;
	}
		
	var arrLunches = new Array();
	arrLunches[arrLunches.length] = new food("Ice Cream","Dessert.png ");
	arrLunches[arrLunches.length] = new food("Fast Food","FastFood.png");
	arrLunches[arrLunches.length] = new food("Fine Dining","FineDining.png");
	arrLunches[arrLunches.length] = new food("Seafood","FreshSeafood.png");
	arrLunches[arrLunches.length] = new food("Hot Dogs","HotDog.png");
	arrLunches[arrLunches.length] = new food("Liquid Lunch","LiquidLunch.png");
	arrLunches[arrLunches.length] = new food("Sausage Joint","Sausage.png");
	arrLunches[arrLunches.length] = new food("Soup &amp; Salad","Soup.png");
	arrLunches[arrLunches.length] = new food("Chinese","TakeOut.png");

	var selectedLunchText = "";

	/* This function runs once the page is loaded, but appMobi is not yet active */
	var init = function(){
	};
	window.addEventListener("load",init,false);  

	/* This code prevents users from dragging the page */
	var preventDefaultScroll = function(event) {
		event.preventDefault();
		window.scroll(0,0);
		return false;
	};
	document.addEventListener('touchmove', preventDefaultScroll, false);


	var serviceName = "twitter1";
	var onDeviceReady=function(){
	
		ddebug("in onDeviceReady");

        // lock orientation
    	AppMobi.device.setRotateOrientation("portrait");
    	AppMobi.device.setAutoRotate(false);
		
		//Size the display to 768
		AppMobi.display.useViewport(320,320);

        //manage power
        AppMobi.device.managePower(true,false);
		
		//hide the splash screen
        AppMobi.device.hideSplashScreen();
		
		if (AppMobi.oAuthAvailable == true)
		{
			verifyTwitterCredentials();
		}
		else
		{
			ddebug("oAuth is not yet available");
		}
				
	};
	
	function queMusic(strExecute)
	{
		AppMobi.player.playSound("sounds/pylSpin.wav");
		setTimeout(strExecute,1550);  //call the code to execute following the music
	}

	function updateTwitterFeed()
	{
		ddebug(document.getElementById('txtEntry').value);
		var status = "status=" + document.getElementById('txtEntry').value;

		var parameters = new AppMobi.OAuth.ProtectedDataParameters();
		parameters.service = serviceName;
		parameters.url = 'https://api.twitter.com/1/statuses/update.xml';
		parameters.id = 'tweet_update';
		parameters.method = 'POST';
		parameters.body = status;

		AppMobi.oauth.getProtectedData(parameters);
	}

	var verificationTimer;
	var verificationTimeout = 60000;
	function verifyTwitterCredentials()
	{
		ddebug("verifying credentials");
		var parameters = new AppMobi.OAuth.ProtectedDataParameters();
		parameters.service = serviceName;
		parameters.url = 'https://api.twitter.com/1/account/verify_credentials.xml';
		parameters.id = 'tweet_get';
		clearTimeout(verificationTimer);
		verificationTimer = setTimeout(function(){ 
			clearTimeout(verificationTimer);
			document.getElementById("divLoggedInAs").innerHTML="Verification Failure";
			AppMobi.notification.alert("The verifictaion has timed out.  Please try again later.","Verification Timeout","OK");
		},verificationTimeout);
		
		//alert(JSON.stringify(parameters));
  
		AppMobi.oauth.getProtectedData(parameters);
	}


	function statusUpdate(evt)
	{
		ddebug("ID: " + evt.id);
		ddebug(evt.response);
		clearTimeout(verificationTimer);

		if (evt.id == "tweet_get")
		{
			//Twitter credentials verified
			document.getElementById("btnPost").style.display="block";
			document.getElementById("divLoggedInAs").innerHTML=evt.response.substring(evt.response.indexOf("<name>")+6,evt.response.indexOf("</name>"));
		}

		if (evt.id == "tweet_update")
		{
			//Twitter feed updated
			AppMobi.notification.alert("Twitter Updated","Success","OK");
		}
	}


	function signOutTwitter()
	{
		alert("unauthorizing service");
		AppMobi.oauth.unauthorizeService(serviceName);
	}
	
	function randomLunch()
	{
		var x=rnd(arrLunches.length);
		document.getElementById("divLunch").innerHTML = '<img id="imgFood" src="images/' + arrLunches[x].image + '" />';
		document.getElementById("divLunchText").innerHTML = arrLunches[x].text;
		
		selectedLunchText = arrLunches[x].text;
		
		if (document.getElementById('txtEntry') != null)
		{
			document.getElementById('txtEntry').innerHTML = "Lunch Call: " + arrLunches[x].text
		}
	}
	
	function rnd(i) //random number generator
	{
		return Math.floor(Math.random()*i);
	}	
	
	//EVENT HANDLERS
	document.addEventListener("appMobi.device.ready",onDeviceReady,false);  // fired once appMobi is ready
	
	document.addEventListener("appMobi.oauth.setup",function(){ ddebug('oAuth ready'); verifyTwitterCredentials(); },false);  // fired once oAuth is ready
	
	document.addEventListener("appMobi.oauth.protected.data",statusUpdate,false);  // fired when data comes back from oAuth
	
	document.addEventListener("appMobi.oauth.busy",function(){ ddebug('oAuth busy');  },false);  // fired if we try to use oAuth when oAuth is already busy with another call

	function ddebug(message)
	{
		console.log("   CONSOLE: " + message + "    ");
	}
	
</script>

</head>
<body style="background-color:#fff;color:white;text-align:center;">
	<div id="divLunch" style="width:98%;min-height:150px;overflow:hidden;"></div>
	<div id="divLunchText" style="color:#fff;position:absolute;top:190px;left:0px; text-align:center;width:320px;text-shadow:1px 1px 1px #333;"></div>
	<div style="position:absolute;bottom:0px;left:0px;">
	
	<img src="images/Lunch_Up.png" onclick="queMusic('randomLunch();');" ontouchstart="this.src='images/Lunch_Over.png';" ontouchend="this.src='images/Lunch_Up.png';" />
	<img id="btnPost" style="display:none;" src="images/Twitter_Up.png" onclick="confirmationBox_show('Lunch Call: '+selectedLunchText,'Post To Twitter','Post','Cancel','updateTwitterFeed();','');" ontouchstart="this.src='images/Twitter_Over.png';" ontouchend="this.src='images/Twitter_Up.png';" />
	<div id="divLoggedInAs" style="width:320px;text-align:center;font-size:14pt;color:#fff;text-shadow:1px 1px 1px #333;font-weight:bold;" onclick="signOutTwitter();">Verifying Twitter Credentials</div>

	</div>
	
	<script src="http://debugmobi.com/target/target-script-min.js#bdb75bdb-f11e-e44b-300c-5d244fbfd4cf"></script>
</body>
</html>
